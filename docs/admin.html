<!DOCTYPE html>
<html>
<head>
  <title>SiteLog Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 30px;
      text-align: center;
    }

    h1 {
      background: rgba(0, 74, 153, 0.7);
      color: white;
      padding: 14px;
      border-radius: 10px;
      width: min(1050px, 100%);
      margin: 0 auto 16px auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    #controls {
      margin: 14px auto 18px auto;
      width: min(1050px, 100%);
      background: rgba(255,255,255,0.95);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .controls-left, .controls-right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input, select, button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
    }

    button {
      cursor: pointer;
      border: none;
      background: #004a99;
      color: white;
      font-weight: 600;
    }
    button:hover { background: #003366; }

    .section-title {
      width: min(1050px, 100%);
      margin: 18px auto 8px auto;
      text-align: left;
      font-weight: 700;
      color: #0b2f55;
    }

    table {
      margin: 10px auto 18px auto;
      width: min(1050px, 100%);
      border-collapse: collapse;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    th {
      background: #004a99;
      color: white;
      padding: 12px;
      font-size: 13px;
      text-align: left;
      white-space: nowrap;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
      vertical-align: top;
    }

    tr:hover { background: rgba(0,74,153,0.08); }

    .liveDot { color: #1b8f2a; font-weight: 800; }
    .outDot { color: #6b7280; font-weight: 800; }

    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      font-weight: 700;
      white-space: nowrap;
    }

    .pill-live { background: #dff5df; color: #1b8f2a; }
    .pill-out { background: #eef2f7; color: #6b7280; }

    .pill-verified { background: #e7f0ff; color: #004a99; }

    .muted { color: #6b7280; }

    /* Grouped view cards */
    .groupWrap {
      width: min(1050px, 100%);
      margin: 0 auto 18px auto;
      text-align: left;
    }
    .personCard {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }
    .personHeader {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      font-weight: 800;
      color: #0b2f55;
    }
    .dayHeader {
      margin-top: 10px;
      font-weight: 800;
      color: #004a99;
    }
    .visitLine {
      padding-left: 10px;
      margin: 6px 0;
    }
    .dayTotal {
      margin-top: 6px;
      font-weight: 800;
      color: #1b8f2a;
    }
  </style>
</head>

<body>

<h1>üìã SiteLog Admin Dashboard</h1>

<div id="controls">
  <div class="controls-left">
    <input id="search" placeholder="Search name..." />

    <select id="companyFilter">
      <option value="">All Companies</option>
    </select>

    <select id="purposeFilter">
      <option value="">All Purposes</option>
      <option value="Visiting">Visiting</option>
      <option value="Contractor">Contractor</option>
    </select>
  </div>

  <div class="controls-right">
    <label class="muted">From</label>
    <input type="date" id="fromDate" />

    <label class="muted">To</label>
    <input type="date" id="toDate" />

    <label class="muted" style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" id="groupToggle" />
      Group by day
    </label>

    
    <button onclick="openSiteModal()">‚ûï Manage Sites</button>
    <button onclick="loadData()">üîÑ Refresh</button>
  </div>
</div>

<div class="section-title">üü¢ Live On Site (always)</div>
<table>
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Duration</th>
      <th>Device</th>
      <th>GPS</th>
    </tr>
  </thead>
  <tbody id="liveRows"></tbody>
</table>

<div class="section-title">üïò Logs (date filter + optional grouping)</div>

<!-- Normal table view -->
<table id="logsTable">
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Check Out</th>
      <th>Duration</th>
      <th>Device</th>
      <th>GPS</th>
    </tr>
  </thead>
  <tbody id="logRows"></tbody>
</table>

<!-- Grouped view -->
<div id="groupedWrap" class="groupWrap" style="display:none;"></div>

<script>
  // IMPORTANT: set this to your worker base
  const API_BASE = "https://sitelog-api.jamie-def.workers.dev";

  let allVisits = [];      // unfiltered (used for LIVE always)
  let filteredVisits = []; // date-filtered (used for Logs)

  function toLocal(ts) {
    if (!ts) return "-";
    return new Date(ts.replace(" ", "T") + "Z").toLocaleString();
  }

  function minutesBetween(a, b) {
    if (!a) return 0;
    const start = new Date(a.replace(" ", "T") + "Z");
    const end = b ? new Date(b.replace(" ", "T") + "Z") : new Date();
    return Math.max(0, Math.round((end - start) / 60000));
  }

  function fmtDuration(mins) {
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    if (h <= 0) return `${m}m`;
    return `${h}h ${m}m`;
  }

  function nameOf(v) {
    const fn = v.first_name || "Unknown";
    const ln = v.last_name || "";
    return (fn + " " + ln).trim();
  }

  function gpsText(v) {
    const has = (v.lat != null && v.lng != null);
    if (!has) return `<span class="muted">-</span>`;
    const acc = (v.accuracy != null) ? `${Math.round(v.accuracy)}m` : "?";
    return `${acc}`;
  }

  function devicePill(v) {
    // Device is "verified" by virtue of being in devices table + linked;
    // you can tighten this later (e.g., accuracy threshold, site geofence).
    return `<span class="pill pill-verified">Verified</span>`;
  }

  function passFilters(v) {
    const search = document.getElementById("search").value.toLowerCase().trim();
    const company = document.getElementById("companyFilter").value;
    const purpose = document.getElementById("purposeFilter").value;

    const nm = nameOf(v).toLowerCase();
    return (
      (!search || nm.includes(search)) &&
      (!company || v.company === company) &&
      (!purpose || v.purpose === purpose)
    );
  }

  function buildCompanyFilter(source) {
    const companySelect = document.getElementById("companyFilter");
    const companies = [...new Set(source.map(v => v.company).filter(Boolean))].sort();
    const current = companySelect.value;

    companySelect.innerHTML =
      `<option value="">All Companies</option>` +
      companies.map(c => `<option value="${c}">${c}</option>`).join("");

    // try to preserve selection
    if ([...companySelect.options].some(o => o.value === current)) {
      companySelect.value = current;
    }
  }

  async function fetchAll() {
    // Full dataset (up to worker limit) so LIVE can always be shown.
    const res = await fetch(`${API_BASE}/admin`);
    const data = await res.json();
    return data.visits || [];
  }

  async function fetchRange(from, to) {
    // Date filtered for logs view
    const qs = new URLSearchParams();
    if (from && to) { qs.set("from", from); qs.set("to", to); }
    const url = `${API_BASE}/admin${qs.toString() ? "?" + qs.toString() : ""}`;
    const res = await fetch(url);
    const data = await res.json();
    return data.visits || [];
  }

  function renderLive() {
    const tbody = document.getElementById("liveRows");
    const live = allVisits
      .filter(v => !v.check_out_at)
      .filter(passFilters)
      .sort((a,b) => (a.check_in_at < b.check_in_at ? 1 : -1));

    tbody.innerHTML = live.map(v => {
      const mins = minutesBetween(v.check_in_at, v.check_out_at);
      return `
        <tr>
          <td><span class="pill pill-live"><span class="liveDot">‚óè</span> LIVE</span></td>
          <td>${nameOf(v)}</td>
          <td>${v.company || "-"}</td>
          <td>${v.purpose || "-"}</td>
          <td>${v.site_code || "-"}</td>
          <td>${toLocal(v.check_in_at)}</td>
          <td>${fmtDuration(mins)}</td>
          <td>${devicePill(v)}</td>
          <td>${gpsText(v)}</td>
        </tr>
      `;
    }).join("");

    if (!live.length) {
      tbody.innerHTML = `
        <tr><td colspan="9" class="muted" style="text-align:center;">No one currently onsite.</td></tr>
      `;
    }
  }

  function renderLogsTable() {
    const tbody = document.getElementById("logRows");

    const logs = filteredVisits
      .filter(passFilters)
      .sort((a,b) => (a.check_in_at < b.check_in_at ? 1 : -1));

    tbody.innerHTML = logs.map(v => {
      const live = !v.check_out_at;
      const mins = minutesBetween(v.check_in_at, v.check_out_at);

      return `
        <tr>
          <td>${live
            ? `<span class="pill pill-live"><span class="liveDot">‚óè</span> LIVE</span>`
            : `<span class="pill pill-out"><span class="outDot">‚úî</span> OUT</span>`}
          </td>
          <td>${nameOf(v)}</td>
          <td>${v.company || "-"}</td>
          <td>${v.purpose || "-"}</td>
          <td>${v.site_code || "-"}</td>
          <td>${toLocal(v.check_in_at)}</td>
          <td>${v.check_out_at ? toLocal(v.check_out_at) : "-"}</td>
          <td>${live ? "On Site" : fmtDuration(mins)}</td>
          <td>${devicePill(v)}</td>
          <td>${gpsText(v)}</td>
        </tr>
      `;
    }).join("");

    if (!logs.length) {
      tbody.innerHTML = `
        <tr><td colspan="10" class="muted" style="text-align:center;">No logs match your filters.</td></tr>
      `;
    }
  }

  function groupByPersonDay(visits) {
    // returns: { personKey: { meta: {...}, days: { YYYY-MM-DD: [visits...] } } }
    const out = {};
    for (const v of visits) {
      if (!passFilters(v)) continue;

      const personKey = `${nameOf(v)}||${v.company || ""}||${v.purpose || ""}`;
      const day = (v.check_in_at || "").slice(0, 10) || "Unknown day";

      if (!out[personKey]) {
        out[personKey] = {
          name: nameOf(v),
          company: v.company || "-",
          purpose: v.purpose || "-",
          days: {}
        };
      }
      if (!out[personKey].days[day]) out[personKey].days[day] = [];
      out[personKey].days[day].push(v);
    }

    // sort visits within each day oldest->newest
    for (const k of Object.keys(out)) {
      for (const d of Object.keys(out[k].days)) {
        out[k].days[d].sort((a,b) => (a.check_in_at > b.check_in_at ? 1 : -1));
      }
    }

    return out;
  }

  function renderGrouped() {
    const wrap = document.getElementById("groupedWrap");
    const obj = groupByPersonDay(filteredVisits);

    const keys = Object.keys(obj).sort((a,b) => obj[a].name.localeCompare(obj[b].name));

    if (!keys.length) {
      wrap.innerHTML = `<div class="muted" style="text-align:center;">No logs match your filters.</div>`;
      return;
    }

    wrap.innerHTML = keys.map(k => {
      const p = obj[k];
      const days = Object.keys(p.days).sort((a,b) => (a < b ? 1 : -1)); // newest day first

      const dayBlocks = days.map(day => {
        const arr = p.days[day];
        let totalMins = 0;

        const lines = arr.map(v => {
          const mins = minutesBetween(v.check_in_at, v.check_out_at);
          if (v.check_out_at) totalMins += mins;

          const inT = toLocal(v.check_in_at);
          const outT = v.check_out_at ? toLocal(v.check_out_at) : "LIVE";
          const dur = v.check_out_at ? fmtDuration(mins) : "On Site";

          return `<div class="visitLine">‚Ä¢ ${v.site_code || "-"} ‚Äî ${inT} ‚Üí ${outT} <span class="muted">(${dur})</span></div>`;
        }).join("");

        return `
          <div class="dayHeader">üìÖ ${day}</div>
          ${lines}
          <div class="dayTotal">Total time: ${fmtDuration(totalMins)}</div>
        `;
      }).join("");

      return `
        <div class="personCard">
          <div class="personHeader">
            <div>${p.name}</div>
            <div class="muted">${p.company} ‚Ä¢ ${p.purpose}</div>
          </div>
          ${dayBlocks}
        </div>
      `;
    }).join("");
  }

  function renderAll() {
    // LIVE always shown
    renderLive();

    const grouped = document.getElementById("groupToggle").checked;
    document.getElementById("logsTable").style.display = grouped ? "none" : "";
    document.getElementById("groupedWrap").style.display = grouped ? "" : "none";

    if (grouped) renderGrouped();
    else renderLogsTable();
  }

  async function loadData() {
    // 1) Always pull ALL for LIVE
    allVisits = await fetchAll();

    // 2) Pull date-filtered for logs (defaults to all if no dates selected)
    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    filteredVisits = await fetchRange(from, to);

    // Build company filter from full dataset (so options are always available)
    buildCompanyFilter(allVisits);

    renderAll();
  }

  // reactive filters
  document.getElementById("search").addEventListener("input", renderAll);
  document.getElementById("companyFilter").addEventListener("change", renderAll);
  document.getElementById("purposeFilter").addEventListener("change", renderAll);
  document.getElementById("groupToggle").addEventListener("change", renderAll);

  // default load
  loadData();
</script>


<!-- ================= SITE MODAL ================= -->
<div id="siteModal" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
">
  <div style="
    width: 700px;
    max-width: 95%;
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.35);
    text-align: center;
  ">
    <h2>üìç Add New Site</h2>
    <p>Click the map to drop a pin, enter site name, save.</p>

    <div id="modalMap" style="height:400px;border-radius:12px;margin-top:10px;"></div>

    <input id="modalSiteName" placeholder="Site Name" style="margin-top:10px;padding:10px;width:80%;border-radius:8px;border:1px solid #ccc;">
    <div style="margin-top:10px;">
      <button onclick="saveSite()">Save Site</button>
      <button onclick="closeSiteModal()" style="background:#ccc;color:#333;">Cancel</button>
    </div>
  </div>
</div>

<script>
let modalMap;
let modalMarker = null;
let chosenLat = null;
let chosenLng = null;

function openSiteModal() {
  document.getElementById("siteModal").style.display = "flex";

  setTimeout(() => {
    if (!modalMap) {
      modalMap = new google.maps.Map(document.getElementById("modalMap"), {
        center: { lat: 51.5, lng: -0.12 },
        zoom: 6
      });

      modalMap.addListener("click", (e) => {
        chosenLat = e.latLng.lat();
        chosenLng = e.latLng.lng();

        if (modalMarker) modalMarker.setMap(null);

        modalMarker = new google.maps.Marker({
          position: { lat: chosenLat, lng: chosenLng },
          map: modalMap
        });
      });
    }
  }, 200);
}

function closeSiteModal() {
  document.getElementById("siteModal").style.display = "none";
}

async function saveSite() {
  const name = document.getElementById("modalSiteName").value.trim();

  if (!name || chosenLat == null) {
    alert("Drop a pin and enter a name.");
    return;
  }

  await fetch("https://sitelog-api.jamie-def.workers.dev/add-site", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      siteName: name,
      lat: chosenLat,
      lng: chosenLng
    })
  });

  alert("‚úÖ Site saved: " + name);
  closeSiteModal();
}
</script>
<!-- ================================================= -->

</body>
</html>
