<!DOCTYPE html>
<html>
<head>
  <title>SiteLog Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- PDF LIBRARY -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 30px;
      text-align: center;
    }

    h1 {
      background: rgba(0, 74, 153, 0.7);
      color: white;
      padding: 14px;
      border-radius: 10px;
      width: min(1050px, 100%);
      margin: 0 auto 16px auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    #controls {
      margin: 14px auto 18px auto;
      width: min(1050px, 100%);
      background: rgba(255,255,255,0.95);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .controls-left, .controls-right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input, select, button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
    }

    button {
      cursor: pointer;
      border: none;
      background: #004a99;
      color: white;
      font-weight: 600;
    }

    button:hover { background: #003366; }

    .dangerBtn {
      background: #dc2626;
    }

    .dangerBtn:hover {
      background: #b91c1c;
    }

    .section-title {
      width: min(1050px, 100%);
      margin: 18px auto 8px auto;
      text-align: left;
      font-weight: 700;
      color: #0b2f55;
    }

    table {
      margin: 10px auto 18px auto;
      width: min(1050px, 100%);
      border-collapse: collapse;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    th {
      background: #004a99;
      color: white;
      padding: 12px;
      font-size: 13px;
      text-align: left;
      white-space: nowrap;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
      vertical-align: top;
    }

    tr:hover { background: rgba(0,74,153,0.08); }

    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      font-weight: 700;
      white-space: nowrap;
    }

    .pill-live { background: #dff5df; color: #1b8f2a; }
    .pill-out { background: #eef2f7; color: #6b7280; }

    .muted { color: #6b7280; }

    /* MODALS */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modalContent {
      width: 600px;
      max-width: 95%;
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      text-align: center;
    }

  </style>
</head>

<body>

<h1>ðŸ“‹ SiteLog Admin Dashboard</h1>

<div id="controls">
  <div class="controls-left">
    <input id="search" placeholder="Search name..." />

    <select id="companyFilter">
      <option value="">All Companies</option>
    </select>

    <select id="purposeFilter">
      <option value="">All Purposes</option>
      <option value="Visiting">Visiting</option>
      <option value="Contractor">Contractor</option>
    </select>

    <!-- SITE FILTER ADDED -->
    <select id="siteFilter">
      <option value="">All Sites</option>
    </select>
  </div>

  <div class="controls-right">
    <label class="muted">From</label>
    <input type="date" id="fromDate" />

    <label class="muted">To</label>
    <input type="date" id="toDate" />

    <button onclick="openExportModal()">ðŸ“„ Export PDF</button>
    <button onclick="window.location.href='sites.html'">âž• Manage Sites</button>
    <button onclick="loadData()">ðŸ”„ Refresh</button>
  </div>
</div>

<div class="section-title">ðŸŸ¢ Live On Site (always)</div>
<table>
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Duration</th>
      <th>Device</th>
      <th>GPS</th>
    </tr>
  </thead>
  <tbody id="liveRows"></tbody>
</table>

<div class="section-title">ðŸ•˜ Logs</div>

<table id="logsTable">
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Check Out</th>
      <th>Duration</th>
      <th>GPS</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="logRows"></tbody>
</table>

<script>

const API_BASE = "https://sitelog-api.jamie-def.workers.dev";

let allVisits = [];
let filteredVisits = [];
let deleteId = null;

/* -------------------- HELPERS -------------------- */

function toLocal(ts){ if(!ts) return "-"; return new Date(ts.replace(" ","T")+"Z").toLocaleString();}
function minutesBetween(a,b){ if(!a) return 0; const start=new Date(a.replace(" ","T")+"Z"); const end=b?new Date(b.replace(" ","T")+"Z"):new Date(); return Math.max(0,Math.round((end-start)/60000));}
function fmtDuration(mins){ const h=Math.floor(mins/60); const m=mins%60; return h>0?`${h}h ${m}m`:`${m}m`;}
function nameOf(v){ return `${v.first_name||""} ${v.last_name||""}`.trim(); }

/* -------------------- FILTERS -------------------- */

function passFilters(v){
  const search=document.getElementById("search").value.toLowerCase().trim();
  const company=document.getElementById("companyFilter").value;
  const purpose=document.getElementById("purposeFilter").value;
  const site=document.getElementById("siteFilter").value;
  const nm=nameOf(v).toLowerCase();

  return (
    (!search||nm.includes(search)) &&
    (!company||v.company===company) &&
    (!purpose||v.purpose===purpose) &&
    (!site||v.site_code===site)
  );
}

function buildSiteFilter(){
  const select=document.getElementById("siteFilter");
  const sites=[...new Set(filteredVisits.map(v=>v.site_code).filter(Boolean))].sort();
  const current=select.value;

  select.innerHTML='<option value="">All Sites</option>'+
    sites.map(s=>`<option value="${s}">${s}</option>`).join("");

  if([...select.options].some(o=>o.value===current)){
    select.value=current;
  }
}

/* -------------------- FETCH -------------------- */

async function fetchAll(){ const res=await fetch(`${API_BASE}/admin`); const data=await res.json(); return data.visits||[]; }
async function fetchRange(from,to){
  const qs=new URLSearchParams();
  if(from&&to){qs.set("from",from);qs.set("to",to);}
  const res=await fetch(`${API_BASE}/admin?${qs.toString()}`);
  const data=await res.json();
  return data.visits||[];
}

/* -------------------- RENDER -------------------- */

function renderLive(){
  const tbody=document.getElementById("liveRows");
  const live=allVisits.filter(v=>!v.check_out_at).filter(passFilters);
  tbody.innerHTML=live.map(v=>`
    <tr>
      <td><span class="pill pill-live">LIVE</span></td>
      <td>${nameOf(v)}</td>
      <td>${v.company||"-"}</td>
      <td>${v.purpose||"-"}</td>
      <td>${v.site_code||"-"}</td>
      <td>${toLocal(v.check_in_at)}</td>
      <td>${fmtDuration(minutesBetween(v.check_in_at,v.check_out_at))}</td>
      <td>${v.accuracy||"-"}</td>
    </tr>
  `).join("");
}

function renderLogs(){
  const tbody=document.getElementById("logRows");
  tbody.innerHTML="";

  const logs=filteredVisits.filter(passFilters);

  if(!logs.length){
    tbody.innerHTML=`<tr><td colspan="10" class="muted" style="text-align:center;">No logs found.</td></tr>`;
    return;
  }

  // --- DD/MM/YY helper for day headers (input is YYYY-MM-DD) ---
  function fmtDay(dayStr){
    if(!dayStr || dayStr.length < 10) return dayStr || "-";
    const y=dayStr.slice(2,4);
    const m=dayStr.slice(5,7);
    const d=dayStr.slice(8,10);
    return `${d}/${m}/${y}`;
  }

  // -------- GROUP BY ENGINEER + DAY --------
  const grouped={};

  logs.forEach(v=>{
    const person=nameOf(v) || "Unknown";
    if(!grouped[person]) grouped[person]={};
    const day=(v.check_in_at||"").slice(0,10) || "Unknown";
    if(!grouped[person][day]) grouped[person][day]=[];
    grouped[person][day].push(v);
  });

  Object.keys(grouped).sort().forEach(person=>{

    // Engineer Header Row
    const headerRow=document.createElement("tr");
    headerRow.innerHTML=`
      <td colspan="10" style="background:#eef2f7;font-weight:800;text-align:center;">
        ðŸ‘¤ ${person}
      </td>
    `;
    tbody.appendChild(headerRow);

    let engineerTotal=0;

    Object.keys(grouped[person]).sort().forEach(day=>{

      let dayTotal=0;

      // Day Header
      const dayRow=document.createElement("tr");
      dayRow.innerHTML=`
        <td colspan="10" style="background:#f8fafc;font-weight:700;text-align:center;">
          ðŸ“… ${fmtDay(day)}
        </td>
      `;
      tbody.appendChild(dayRow);

      // sort within day: oldest -> newest
      grouped[person][day].sort((a,b)=>{
        const aa=(a.check_in_at||"");
        const bb=(b.check_in_at||"");
        return aa>bb ? 1 : (aa<bb ? -1 : 0);
      });

      grouped[person][day].forEach(v=>{
        const mins=minutesBetween(v.check_in_at,v.check_out_at);
        if(v.check_out_at) dayTotal+=mins;

        const row=document.createElement("tr");
        row.innerHTML=`
          <td>${v.check_out_at?"OUT":"LIVE"}</td>
          <td>${nameOf(v)}</td>
          <td>${v.company||"-"}</td>
          <td>${v.purpose||"-"}</td>
          <td>${v.site_code||"-"}</td>
          <td>${toLocal(v.check_in_at)}</td>
          <td>${v.check_out_at?toLocal(v.check_out_at):"-"}</td>
          <td>${v.check_out_at?fmtDuration(mins):"On Site"}</td>
          <td>${v.accuracy||"-"}</td>
          <td>
            <button class="dangerBtn"
              onclick="openDeleteModal('${v.visit_id}','${nameOf(v)}','${v.site_code}')">
              Delete
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      engineerTotal+=dayTotal;

      // Day Total Row (CENTRED)
      const totalRow=document.createElement("tr");
      totalRow.innerHTML=`
        <td colspan="10" style="text-align:center;font-weight:700;color:#1b8f2a;">
          Total for ${fmtDay(day)}: ${fmtDuration(dayTotal)}
        </td>
      `;
      tbody.appendChild(totalRow);
    });

    // Engineer Grand Total (CENTRED)
    const grandRow=document.createElement("tr");
    grandRow.innerHTML=`
      <td colspan="10" style="text-align:center;font-weight:800;color:#004a99;">
        Grand Total for ${person}: ${fmtDuration(engineerTotal)}
      </td>
    `;
    tbody.appendChild(grandRow);
  });
}

function renderAll(){
  buildSiteFilter();
  renderLive();
  renderLogs();
}

/* -------------------- LOAD -------------------- */

async function loadData(){
  allVisits=await fetchAll();
  const from=document.getElementById("fromDate").value;
  const to=document.getElementById("toDate").value;
  filteredVisits=await fetchRange(from,to);
  renderAll();
}

document.getElementById("search").addEventListener("input",renderAll);
document.getElementById("companyFilter").addEventListener("change",renderAll);
document.getElementById("purposeFilter").addEventListener("change",renderAll);
document.getElementById("siteFilter").addEventListener("change",renderAll);
loadData();

/* -------------------- DELETE -------------------- */

function openDeleteModal(id,name,site){
  deleteId=id;
  document.getElementById("deleteText").innerText=`Delete visit for ${name} at ${site}?`;
  document.getElementById("deleteModal").style.display="flex";
}

function closeDeleteModal(){
  document.getElementById("deleteModal").style.display="none";
  deleteId=null;
}

async function confirmDelete(){
  if(!deleteId) return;
  const res=await fetch(API_BASE+"/delete-visit",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({visitId:deleteId})
  });
  const data=await res.json();
  if(data.ok){ loadData(); }
  closeDeleteModal();
}

/* -------------------- PDF MODAL -------------------- */

function openExportModal(){
  document.getElementById("exportModal").style.display="flex";
}

function closeExportModal(){
  document.getElementById("exportModal").style.display="none";
}

function generatePDF(){
  const site=document.getElementById("siteFilter").value||"All Sites";
  const totalVisits=filteredVisits.length;
  const totalMinutes=filteredVisits.reduce((sum,v)=>v.check_out_at?sum+minutesBetween(v.check_in_at,v.check_out_at):sum,0);

  const wrapper=document.createElement("div");
  wrapper.innerHTML=`
    <h2>SiteLog Report</h2>
    <div><strong>Site:</strong> ${site}</div>
    <div><strong>Total Visits:</strong> ${totalVisits}</div>
    <div><strong>Total Hours:</strong> ${(totalMinutes/60).toFixed(2)}</div>
    <br>
  `;
  wrapper.appendChild(document.getElementById("logsTable").cloneNode(true));

  html2pdf().set({
    margin:0.3,
    filename:"SiteLog_Report.pdf",
    jsPDF:{unit:"in",format:"a4",orientation:"landscape"}
  }).from(wrapper).save();

  closeExportModal();
}

</script>

<!-- DELETE MODAL -->
<div id="deleteModal" class="modal">
  <div class="modalContent">
    <h3>Delete Visit</h3>
    <p id="deleteText"></p>
    <button class="dangerBtn" onclick="confirmDelete()">Confirm Delete</button>
    <button onclick="closeDeleteModal()" style="background:#ccc;color:#333;">Cancel</button>
  </div>
</div>

<!-- EXPORT MODAL -->
<div id="exportModal" class="modal">
  <div class="modalContent">
    <h3>Export Report</h3>
    <p>This will export current filtered results.</p>
    <button onclick="generatePDF()">Generate PDF</button>
    <button onclick="closeExportModal()" style="background:#ccc;color:#333;">Cancel</button>
  </div>
</div>

</body>
</html>
