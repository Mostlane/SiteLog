<!DOCTYPE html>
<html>
<head>
  <title>SiteLog Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- PDF LIBRARY ADDED -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 30px;
      text-align: center;
    }

    h1 {
      background: rgba(0, 74, 153, 0.7);
      color: white;
      padding: 14px;
      border-radius: 10px;
      width: min(1050px, 100%);
      margin: 0 auto 16px auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    #controls {
      margin: 14px auto 18px auto;
      width: min(1050px, 100%);
      background: rgba(255,255,255,0.95);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .controls-left, .controls-right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input, select, button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
    }

    button {
      cursor: pointer;
      border: none;
      background: #004a99;
      color: white;
      font-weight: 600;
    }
    button:hover { background: #003366; }

    .dangerBtn {
      background: #dc2626;
    }

    .dangerBtn:hover {
      background: #b91c1c;
    }

    .section-title {
      width: min(1050px, 100%);
      margin: 18px auto 8px auto;
      text-align: left;
      font-weight: 700;
      color: #0b2f55;
    }

    table {
      margin: 10px auto 18px auto;
      width: min(1050px, 100%);
      border-collapse: collapse;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    th {
      background: #004a99;
      color: white;
      padding: 12px;
      font-size: 13px;
      text-align: left;
      white-space: nowrap;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
      vertical-align: top;
    }

    tr:hover { background: rgba(0,74,153,0.08); }

    .liveDot { color: #1b8f2a; font-weight: 800; }
    .outDot { color: #6b7280; font-weight: 800; }

    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      font-weight: 700;
      white-space: nowrap;
    }

    .pill-live { background: #dff5df; color: #1b8f2a; }
    .pill-out { background: #eef2f7; color: #6b7280; }

    .pill-verified { background: #e7f0ff; color: #004a99; }

    .muted { color: #6b7280; }

    .groupWrap {
      width: min(1050px, 100%);
      margin: 0 auto 18px auto;
      text-align: left;
    }

    .personCard {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .personHeader {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
      font-weight: 800;
      color: #0b2f55;
    }

    .dayHeader {
      margin-top: 10px;
      font-weight: 800;
      color: #004a99;
    }

    .visitLine {
      padding-left: 10px;
      margin: 6px 0;
    }

    .dayTotal {
      margin-top: 6px;
      font-weight: 800;
      color: #1b8f2a;
    }
  </style>
</head>

<body>

<h1>üìã SiteLog Admin Dashboard</h1>

<div id="controls">
  <div class="controls-left">
    <input id="search" placeholder="Search name..." />
    <select id="companyFilter">
      <option value="">All Companies</option>
    </select>
    <select id="purposeFilter">
      <option value="">All Purposes</option>
      <option value="Visiting">Visiting</option>
      <option value="Contractor">Contractor</option>
    </select>
  </div>

  <div class="controls-right">
    <label class="muted">From</label>
    <input type="date" id="fromDate" />
    <label class="muted">To</label>
    <input type="date" id="toDate" />

    <label class="muted" style="display:flex;align-items:center;gap:6px;">
      <input type="checkbox" id="groupToggle" />
      Group by day
    </label>

    <button onclick="exportPDF()">üìÑ Export PDF</button>
    <button onclick="window.location.href='sites.html'">‚ûï Manage Sites</button>
    <button onclick="loadData()">üîÑ Refresh</button>
  </div>
</div>

<div class="section-title">üü¢ Live On Site (always)</div>
<table>
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Duration</th>
      <th>Device</th>
      <th>GPS</th>
    </tr>
  </thead>
  <tbody id="liveRows"></tbody>
</table>

<div class="section-title">üïò Logs (date filter + optional grouping)</div>

<table id="logsTable">
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Check Out</th>
      <th>Duration</th>
      <th>Device</th>
      <th>GPS</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="logRows"></tbody>
</table>

<div id="groupedWrap" class="groupWrap" style="display:none;"></div>

<script>
const API_BASE = "https://sitelog-api.jamie-def.workers.dev";

let allVisits = [];
let filteredVisits = [];
let deleteId = null;

function toLocal(ts){ if(!ts) return "-"; return new Date(ts.replace(" ","T")+"Z").toLocaleString();}
function minutesBetween(a,b){ if(!a) return 0; const start=new Date(a.replace(" ","T")+"Z"); const end=b?new Date(b.replace(" ","T")+"Z"):new Date(); return Math.max(0,Math.round((end-start)/60000));}
function fmtDuration(mins){ const h=Math.floor(mins/60); const m=mins%60; if(h<=0) return `${m}m`; return `${h}h ${m}m`;}
function nameOf(v){ const fn=v.first_name||"Unknown"; const ln=v.last_name||""; return (fn+" "+ln).trim();}
function gpsText(v){ const has=(v.lat!=null&&v.lng!=null); if(!has) return `<span class="muted">-</span>`; const acc=(v.accuracy!=null)?`${Math.round(v.accuracy)}m`:"?"; return acc;}
function devicePill(){ return `<span class="pill pill-verified">Verified</span>`;}

function passFilters(v){
  const search=document.getElementById("search").value.toLowerCase().trim();
  const company=document.getElementById("companyFilter").value;
  const purpose=document.getElementById("purposeFilter").value;
  const nm=nameOf(v).toLowerCase();
  return ((!search||nm.includes(search))&&(!company||v.company===company)&&(!purpose||v.purpose===purpose));
}

async function fetchAll(){ const res=await fetch(`${API_BASE}/admin`); const data=await res.json(); return data.visits||[];}
async function fetchRange(from,to){
  const qs=new URLSearchParams();
  if(from&&to){qs.set("from",from);qs.set("to",to);}
  const url=`${API_BASE}/admin${qs.toString()?"?"+qs.toString():""}`;
  const res=await fetch(url);
  const data=await res.json();
  return data.visits||[];
}

function renderLive(){
  const tbody=document.getElementById("liveRows");
  const live=allVisits.filter(v=>!v.check_out_at).filter(passFilters).sort((a,b)=>(a.check_in_at<b.check_in_at?1:-1));
  tbody.innerHTML=live.map(v=>{
    const mins=minutesBetween(v.check_in_at,v.check_out_at);
    return `<tr>
      <td><span class="pill pill-live"><span class="liveDot">‚óè</span> LIVE</span></td>
      <td>${nameOf(v)}</td>
      <td>${v.company||"-"}</td>
      <td>${v.purpose||"-"}</td>
      <td>${v.site_code||"-"}</td>
      <td>${toLocal(v.check_in_at)}</td>
      <td>${fmtDuration(mins)}</td>
      <td>${devicePill()}</td>
      <td>${gpsText(v)}</td>
    </tr>`;
  }).join("");
  if(!live.length){tbody.innerHTML=`<tr><td colspan="9" class="muted" style="text-align:center;">No one currently onsite.</td></tr>`;}
}

function renderLogsTable(){
  const tbody=document.getElementById("logRows");
  const logs=filteredVisits.filter(passFilters).sort((a,b)=>(a.check_in_at<b.check_in_at?1:-1));
  tbody.innerHTML=logs.map(v=>{
    const live=!v.check_out_at;
    const mins=minutesBetween(v.check_in_at,v.check_out_at);
    return `<tr>
      <td>${live?`<span class="pill pill-live"><span class="liveDot">‚óè</span> LIVE</span>`:`<span class="pill pill-out"><span class="outDot">‚úî</span> OUT</span>`}</td>
      <td>${nameOf(v)}</td>
      <td>${v.company||"-"}</td>
      <td>${v.purpose||"-"}</td>
      <td>${v.site_code||"-"}</td>
      <td>${toLocal(v.check_in_at)}</td>
      <td>${v.check_out_at?toLocal(v.check_out_at):"-"}</td>
      <td>${live?"On Site":fmtDuration(mins)}</td>
      <td>${devicePill()}</td>
      <td>${gpsText(v)}</td>
      <td><button class="dangerBtn" onclick="openDeleteModal('${v.visit_id}','${nameOf(v)}','${v.site_code}')">Delete</button></td>
    </tr>`;
  }).join("");
  if(!logs.length){tbody.innerHTML=`<tr><td colspan="11" class="muted" style="text-align:center;">No logs match your filters.</td></tr>`;}
}

function renderAll(){
  renderLive();
  const grouped=document.getElementById("groupToggle").checked;
  document.getElementById("logsTable").style.display=grouped?"none":"";
  document.getElementById("groupedWrap").style.display=grouped?"":"none";
  renderLogsTable();
}

async function loadData(){
  allVisits=await fetchAll();
  const from=document.getElementById("fromDate").value;
  const to=document.getElementById("toDate").value;
  filteredVisits=await fetchRange(from,to);
  renderAll();
}

document.getElementById("search").addEventListener("input",renderAll);
document.getElementById("companyFilter").addEventListener("change",renderAll);
document.getElementById("purposeFilter").addEventListener("change",renderAll);
document.getElementById("groupToggle").addEventListener("change",renderAll);
loadData();

/* DELETE MODAL */
function openDeleteModal(id,name,site){
  deleteId=id;
  document.getElementById("deleteText").innerText=`Delete visit for ${name} at ${site}?`;
  document.getElementById("deleteModal").style.display="flex";
}
function closeDeleteModal(){
  document.getElementById("deleteModal").style.display="none";
  deleteId=null;
}
async function confirmDelete(){
  if(!deleteId) return;
  await fetch(API_BASE+"/delete-visit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({visitId:deleteId})});
  closeDeleteModal();
  loadData();
}

/* PDF EXPORT */
function exportPDF(){
  const element=document.getElementById("logsTable");
  html2pdf().set({
    margin:0.3,
    filename:"SiteLog_Report.pdf",
    image:{type:"jpeg",quality:0.98},
    html2canvas:{scale:2},
    jsPDF:{unit:"in",format:"a4",orientation:"landscape"}
  }).from(element).save();
}
</script>

<!-- DELETE MODAL -->
<div id="deleteModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;justify-content:center;align-items:center;z-index:9999;">
  <div style="width:420px;background:white;border-radius:16px;padding:20px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.35);">
    <h3>Delete Visit</h3>
    <p id="deleteText"></p>
    <div style="margin-top:15px;">
      <button class="dangerBtn" onclick="confirmDelete()">Confirm Delete</button>
      <button onclick="closeDeleteModal()" style="background:#ccc;color:#333;">Cancel</button>
    </div>
  </div>
</div>

</body>
</html>
