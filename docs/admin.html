<!DOCTYPE html>
<html>
<head>
  <title>SiteLog Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- PDF LIBRARY -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 30px;
      text-align: center;
    }

    h1 {
      background: rgba(0, 74, 153, 0.7);
      color: white;
      padding: 14px;
      border-radius: 10px;
      width: min(1050px, 100%);
      margin: 0 auto 16px auto;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    #controls {
      margin: 14px auto 18px auto;
      width: min(1050px, 100%);
      background: rgba(255,255,255,0.95);
      padding: 12px;
      border-radius: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .controls-left, .controls-right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    input, select, button {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      background: white;
    }

    button {
      cursor: pointer;
      border: none;
      background: #004a99;
      color: white;
      font-weight: 600;
    }

    button:hover { background: #003366; }

    .dangerBtn {
      background: #dc2626;
    }

    .dangerBtn:hover {
      background: #b91c1c;
    }

    .ghostBtn{
      background:#eef2f7;
      color:#0f172a;
      border:1px solid #cbd5e1;
      font-weight:700;
    }
    .ghostBtn:hover{ background:#e2e8f0; }

    .section-title {
      width: min(1050px, 100%);
      margin: 18px auto 8px auto;
      text-align: left;
      font-weight: 700;
      color: #0b2f55;
    }

    table {
      margin: 10px auto 18px auto;
      width: min(1050px, 100%);
      border-collapse: collapse;
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    th {
      background: #004a99;
      color: white;
      padding: 12px;
      font-size: 13px;
      text-align: left;
      white-space: nowrap;
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 13px;
      text-align: left;
      vertical-align: top;
    }

    tr:hover { background: rgba(0,74,153,0.08); }

    .pill {
      display: inline-block;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      font-weight: 700;
      white-space: nowrap;
    }

    .pill-live { background: #dff5df; color: #1b8f2a; }
    .pill-out { background: #eef2f7; color: #6b7280; }
    .pill-active{ background:#dbeafe; color:#1d4ed8; }
    .pill-arch{ background:#f1f5f9; color:#64748b; }

    .muted { color: #6b7280; }

    /* MODALS */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modalContent {
      width: 900px;              /* wider for admin tables */
      max-width: 96%;
      max-height: 86vh;
      overflow: auto;
      background: white;
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      text-align: center;
    }

    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .modalHead h3{
      margin:0;
      color:#0b2f55;
      font-size:18px;
      text-align:left;
    }

    .modalNote{
      text-align:left;
      margin:6px 0 14px 0;
      color:#475569;
      font-size:13px;
    }

    .adminTable{
      width:100%;
      border-collapse:collapse;
      margin:10px 0 0 0;
      box-shadow:none;
      border-radius:12px;
      overflow:hidden;
    }

    .adminTable th{
      position:sticky;
      top:0;
      z-index:2;
    }

    .adminTable td input{
      width:100%;
      box-sizing:border-box;
      padding:8px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      font-size:13px;
    }

    .rowBtns{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .tinyBtn{
      padding:8px 10px;
      font-size:12px;
      border-radius:8px;
    }

    .okTick{
      color:#16a34a;
      font-weight:900;
      font-size:16px;
    }
  </style>
</head>

<body>

<h1>üìã SiteLog Admin Dashboard</h1>

<div id="controls">
  <div class="controls-left">
    <input id="search" placeholder="Search name..." />

    <!-- PERSON FILTER (NEW) -->
    <select id="personFilter">
      <option value="">All People</option>
    </select>

    <select id="companyFilter">
      <option value="">All Companies</option>
    </select>

    <select id="purposeFilter">
      <option value="">All Purposes</option>
      <option value="Visiting">Visiting</option>
      <option value="Contractor">Contractor</option>
    </select>

    <!-- SITE FILTER (NOW EXCLUDES ARCHIVED SITES) -->
    <select id="siteFilter">
      <option value="">All Sites</option>
    </select>
  </div>

  <div class="controls-right">
    <label class="muted">From</label>
    <input type="date" id="fromDate" />

    <label class="muted">To</label>
    <input type="date" id="toDate" />

    <button onclick="openExportModal()">üìÑ Export PDF</button>

    <!-- KEEP EXISTING ELEMENT (unchanged) -->
    <button onclick="window.location.href='sites.html'">‚ûï Manage Sites</button>

    <!-- NEW: inline admin panels (does not remove anything) -->
    <button class="ghostBtn" onclick="openSitesModal()">üóÇ View/Edit Sites</button>
    <button class="ghostBtn" onclick="openEngineersModal()">üë∑ Engineers</button>
    <button class="ghostBtn" onclick="openCompaniesModal()">üè¢ Companies</button>

    <button onclick="loadData()">üîÑ Refresh</button>
  </div>
</div>

<div class="section-title">üü¢ Live On Site (always)</div>
<table>
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Duration</th>
      <th>Device</th>
      <th>GPS</th>
    </tr>
  </thead>
  <tbody id="liveRows"></tbody>
</table>

<div class="section-title">üïò Logs</div>

<table id="logsTable">
  <thead>
    <tr>
      <th>Status</th>
      <th>Name</th>
      <th>Company</th>
      <th>Purpose</th>
      <th>Site</th>
      <th>Check In</th>
      <th>Check Out</th>
      <th>Duration</th>
      <th>Device</th>
      <th>GPS</th>
      <th>Location</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="logRows"></tbody>
</table>

<script>
const API_BASE = "https://sitelog-api.jamie-def.workers.dev";

let allVisits = [];
let filteredVisits = [];
let deleteId = null;

/* NEW: cached admin data */
let sitesAll = [];         // all sites (including archived)
let sitesActive = [];      // archived=0 only
let engineersAll = [];     // all engineers/people (including archived)
let engineersActive = [];  // archived=0 only

/* -------------------- HELPERS -------------------- */

function toLocal(ts){
  if(!ts) return "-";
  return new Date(ts.replace(" ","T")+"Z").toLocaleString();
}
function minutesBetween(a,b){
  if(!a) return 0;
  const start=new Date(a.replace(" ","T")+"Z");
  const end=b?new Date(b.replace(" ","T")+"Z"):new Date();
  return Math.max(0,Math.round((end-start)/60000));
}
function fmtDuration(mins){
  const h=Math.floor(mins/60);
  const m=mins%60;
  return h>0?`${h}h ${m}m`:`${m}m`;
}
function nameOf(v){
  return `${v.first_name||""} ${v.last_name||""}`.trim();
}

/* --- DD/MM/YY helper --- */
function fmtDay(dayStr){
  if(!dayStr || dayStr.length < 10) return dayStr || "-";
  const y=dayStr.slice(2,4);
  const m=dayStr.slice(5,7);
  const d=dayStr.slice(8,10);
  return `${d}/${m}/${y}`;
}

/* -------------------- FILTERS -------------------- */

function passFilters(v){
  const search=document.getElementById("search").value.toLowerCase().trim();
  const personSel=document.getElementById("personFilter").value;
  const company=document.getElementById("companyFilter").value;
  const purpose=document.getElementById("purposeFilter").value;
  const site=document.getElementById("siteFilter").value;
  const nm=nameOf(v).toLowerCase();

  const personKey = `${(v.first_name||"").trim()} ${(v.last_name||"").trim()}`.trim();

  return (
    (!search||nm.includes(search)) &&
    (!personSel || personKey === personSel) &&
    (!company||v.company===company) &&
    (!purpose||v.purpose===purpose) &&
    (!site||v.site_code===site)
  );
}

/* Site dropdown must NOT show archived sites */
function buildSiteFilter(){
  const select=document.getElementById("siteFilter");
  const current=select.value;

  // Prefer the active sites list from /sites (archived=0)
  const names = sitesActive.length
    ? sitesActive.map(s => s.site_name).filter(Boolean)
    : [...new Set(filteredVisits.map(v=>v.site_code).filter(Boolean))];

  const sites=[...new Set(names)].sort((a,b)=>a.localeCompare(b));

  select.innerHTML =
    '<option value="">All Sites</option>' +
    sites.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");

  if([...select.options].some(o=>o.value===current)){
    select.value=current;
  }
}

/* NEW: person dropdown must NOT show archived engineers */
function buildPersonFilter(){
  const select=document.getElementById("personFilter");
  const current=select.value;

  let names = [];

  if(engineersActive.length){
    names = engineersActive.map(p => `${(p.first_name||"").trim()} ${(p.last_name||"").trim()}`.trim()).filter(Boolean);
  }else{
    // fallback from visits if engineers endpoint not yet returning
    names = [...new Set(filteredVisits.map(v=>nameOf(v)).filter(Boolean))];
  }

  names = [...new Set(names)].sort((a,b)=>a.localeCompare(b));

  select.innerHTML =
    '<option value="">All People</option>' +
    names.map(n=>`<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join("");

  if([...select.options].some(o=>o.value===current)){
    select.value=current;
  }
}

/* Keep existing company filter, but now actually populate (doesn't remove anything) */
function buildCompanyFilter(){
  const select=document.getElementById("companyFilter");
  const current=select.value;

  const companies=[...new Set(filteredVisits.map(v=>v.company).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  select.innerHTML =
    '<option value="">All Companies</option>' +
    companies.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

  if([...select.options].some(o=>o.value===current)){
    select.value=current;
  }
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* -------------------- FETCH -------------------- */

async function fetchAll(){
  const res=await fetch(`${API_BASE}/admin`);
  const data=await res.json();
  return data.visits||[];
}
async function fetchRange(from,to){
  const qs=new URLSearchParams();
  if(from&&to){qs.set("from",from);qs.set("to",to);}
  const res=await fetch(`${API_BASE}/admin?${qs.toString()}`);
  const data=await res.json();
  return data.visits||[];
}

/* NEW: sites + engineers lists */
async function fetchSites(){
  try{
    const res = await fetch(`${API_BASE}/sites`);
    const data = await res.json();
    sitesAll = data.sites || [];
    sitesActive = sitesAll.filter(s => Number(s.archived||0) === 0);
  }catch(e){
    sitesAll = [];
    sitesActive = [];
  }
}

/* Requires worker endpoints:
   GET /engineers
   POST /update-engineer  { id, firstName, lastName, company, purpose, hourlyRate }
   POST /toggle-engineer  { id }
*/
async function fetchEngineers(){
  try{
    const res = await fetch(`${API_BASE}/engineers`);
    const data = await res.json();
    engineersAll = data.engineers || data.people || [];
    engineersActive = engineersAll.filter(p => Number(p.archived||0) === 0);
  }catch(e){
    engineersAll = [];
    engineersActive = [];
  }
}

/* -------------------- RENDER -------------------- */

function renderLive(){
  const tbody=document.getElementById("liveRows");
  const live=allVisits.filter(v=>!v.check_out_at).filter(passFilters);

  tbody.innerHTML=live.map(v=>`
    <tr>
      <td><span class="pill pill-live">LIVE</span></td>
      <td>${escapeHtml(nameOf(v))}</td>
      <td>${escapeHtml(v.company||"-")}</td>
      <td>${escapeHtml(v.purpose||"-")}</td>
      <td>${escapeHtml(v.site_code||"-")}</td>
      <td>${escapeHtml(toLocal(v.check_in_at))}</td>
      <td>${escapeHtml(fmtDuration(minutesBetween(v.check_in_at,v.check_out_at)))}</td>

      <!-- Device column: tick if device_token exists -->
      <td style="text-align:center;">
        ${v.device_token ? `<span class="okTick">‚úì</span>` : `<span class="muted">-</span>`}
      </td>

      <!-- GPS column: tick if lat/lng exist -->
      <td style="text-align:center;">
        ${(v.lat!=null && v.lng!=null) ? `<span class="okTick">‚úì</span>` : `<span class="muted">-</span>`}
      </td>
    </tr>
  `).join("");

  if(!live.length){
    tbody.innerHTML=`<tr><td colspan="9" class="muted" style="text-align:center;">No one currently onsite.</td></tr>`;
  }
}

function renderLogs(){
  const tbody=document.getElementById("logRows");
  tbody.innerHTML="";

  const logs=filteredVisits.filter(passFilters);

  if(!logs.length){
    tbody.innerHTML=`<tr><td colspan="12" class="muted" style="text-align:center;">No logs found.</td></tr>`;
    return;
  }

  // -------- GROUP BY ENGINEER + DAY --------
  const grouped={};

  logs.forEach(v=>{
    const person=nameOf(v) || "Unknown";
    if(!grouped[person]) grouped[person]={};
    const day=(v.check_in_at||"").slice(0,10) || "Unknown";
    if(!grouped[person][day]) grouped[person][day]=[];
    grouped[person][day].push(v);
  });

  Object.keys(grouped).sort().forEach(person=>{

    const headerRow=document.createElement("tr");
    headerRow.innerHTML=`
      <td colspan="12" style="background:#eef2f7;font-weight:800;text-align:center;">
        üë§ ${escapeHtml(person)}
      </td>
    `;
    tbody.appendChild(headerRow);

    let engineerTotal=0;

    Object.keys(grouped[person]).sort().forEach(day=>{

      let dayTotal=0;

      const dayRow=document.createElement("tr");
      dayRow.innerHTML=`
        <td colspan="12" style="background:#f8fafc;font-weight:700;text-align:center;">
          üìÖ ${escapeHtml(fmtDay(day))}
        </td>
      `;
      tbody.appendChild(dayRow);

      grouped[person][day].sort((a,b)=>{
        return (a.check_in_at||"") > (b.check_in_at||"") ? 1 : -1;
      });

      grouped[person][day].forEach(v=>{
        const mins=minutesBetween(v.check_in_at,v.check_out_at);
        if(v.check_out_at) dayTotal+=mins;

        const hasGPS = (v.lat!=null && v.lng!=null);
        const hasDevice = !!v.device_token;

        const locationLink = hasGPS
          ? `<a href="https://www.google.com/maps?q=${encodeURIComponent(v.lat)},${encodeURIComponent(v.lng)}" target="_blank" style="text-decoration:none;font-size:18px;">üìç</a>`
          : `<span class="muted">-</span>`;

        const row=document.createElement("tr");
        row.innerHTML=`
          <td>${v.check_out_at?"OUT":"LIVE"}</td>
          <td>${escapeHtml(nameOf(v))}</td>
          <td>${escapeHtml(v.company||"-")}</td>
          <td>${escapeHtml(v.purpose||"-")}</td>
          <td>${escapeHtml(v.site_code||"-")}</td>
          <td>${escapeHtml(toLocal(v.check_in_at))}</td>
          <td>${escapeHtml(v.check_out_at?toLocal(v.check_out_at):"-")}</td>
          <td>${escapeHtml(v.check_out_at?fmtDuration(mins):"On Site")}</td>

          <!-- Device Tick -->
          <td style="text-align:center;">
            ${hasDevice ? `<span class="okTick">‚úì</span>` : `<span class="muted">-</span>`}
          </td>

          <!-- GPS Tick -->
          <td style="text-align:center;">
            ${hasGPS ? `<span class="okTick">‚úì</span>` : `<span class="muted">-</span>`}
          </td>

          <!-- Location Pin -->
          <td style="text-align:center;">
            ${locationLink}
          </td>

          <td>
            <button class="dangerBtn"
              onclick="openDeleteModal('${escapeHtml(v.visit_id)}','${escapeHtml(nameOf(v))}','${escapeHtml(v.site_code)}')">
              Delete
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });

      engineerTotal+=dayTotal;

      const totalRow=document.createElement("tr");
      totalRow.innerHTML=`
        <td colspan="12" style="text-align:center;font-weight:700;color:#1b8f2a;">
          Total for ${escapeHtml(fmtDay(day))}: ${escapeHtml(fmtDuration(dayTotal))}
        </td>
      `;
      tbody.appendChild(totalRow);
    });

    const grandRow=document.createElement("tr");
    grandRow.innerHTML=`
      <td colspan="12" style="text-align:center;font-weight:800;color:#004a99;">
        Grand Total for ${escapeHtml(person)}: ${escapeHtml(fmtDuration(engineerTotal))}
      </td>
    `;
    tbody.appendChild(grandRow);
  });
}

function renderAll(){
  buildCompanyFilter();
  buildPersonFilter();
  buildSiteFilter();
  renderLive();
  renderLogs();
}

/* -------------------- LOAD -------------------- */

async function loadData(){

  await Promise.all([fetchSites(), fetchEngineers()]);

  allVisits = await fetchAll();

  const from = document.getElementById("fromDate").value;
  const to   = document.getElementById("toDate").value;

  // If no date filter selected, use all visits
  if (!from || !to) {
    filteredVisits = allVisits.slice();
  } else {
    filteredVisits = await fetchRange(from, to);
  }

  renderAll();
}

document.getElementById("search").addEventListener("input",renderAll);
document.getElementById("personFilter").addEventListener("change",renderAll);
document.getElementById("companyFilter").addEventListener("change",renderAll);
document.getElementById("purposeFilter").addEventListener("change",renderAll);
document.getElementById("siteFilter").addEventListener("change",renderAll);
loadData();

/* -------------------- DELETE -------------------- */

function openDeleteModal(id,name,site){
  deleteId=id;
  document.getElementById("deleteText").innerText=`Delete visit for ${name} at ${site}?`;
  document.getElementById("deleteModal").style.display="flex";
}

function closeDeleteModal(){
  document.getElementById("deleteModal").style.display="none";
  deleteId=null;
}

async function confirmDelete(){
  if(!deleteId) return;
  const res=await fetch(API_BASE+"/delete-visit",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({visitId:deleteId})
  });
  const data=await res.json();
  if(data.ok){ loadData(); }
  closeDeleteModal();
}

/* -------------------- PDF MODAL -------------------- */

function openExportModal(){
  document.getElementById("exportModal").style.display="flex";
}

function closeExportModal(){
  document.getElementById("exportModal").style.display="none";
}

function generatePDF(){
  const site=document.getElementById("siteFilter").value||"All Sites";
  const totalVisits=filteredVisits.filter(passFilters).length;
  const totalMinutes=filteredVisits
    .filter(passFilters)
    .reduce((sum,v)=>v.check_out_at?sum+minutesBetween(v.check_in_at,v.check_out_at):sum,0);

  const wrapper=document.createElement("div");
  wrapper.innerHTML=`
    <h2>SiteLog Report</h2>
    <div><strong>Site:</strong> ${escapeHtml(site)}</div>
    <div><strong>Total Visits:</strong> ${escapeHtml(totalVisits)}</div>
    <div><strong>Total Hours:</strong> ${escapeHtml((totalMinutes/60).toFixed(2))}</div>
    <br>
  `;
  wrapper.appendChild(document.getElementById("logsTable").cloneNode(true));

  html2pdf().set({
    margin:0.3,
    filename:"SiteLog_Report.pdf",
    jsPDF:{unit:"in",format:"a4",orientation:"landscape"}
  }).from(wrapper).save();

  closeExportModal();
}

/* ======================================================================
   NEW: SITES ADMIN MODAL (edit + archive toggle)
   Uses worker:
     GET  /sites
     POST /update-site { id, siteName, radius }
     POST /toggle-site { id }
====================================================================== */

function openSitesModal(){
  document.getElementById("sitesModal").style.display="flex";
  renderSitesAdminTable();
}

function closeSitesModal(){
  document.getElementById("sitesModal").style.display="none";
}

function renderSitesAdminTable(){
  const wrap = document.getElementById("sitesAdminBody");
  if(!sitesAll.length){
    wrap.innerHTML = `<div class="muted" style="text-align:left;">No sites returned from /sites.</div>`;
    return;
  }

  const rows = sitesAll
    .slice()
    .sort((a,b)=>String(a.site_name||"").localeCompare(String(b.site_name||"")))
    .map(s=>{
      const isArch = Number(s.archived||0) === 1;
      const statusPill = isArch
        ? `<span class="pill pill-arch">ARCHIVED</span>`
        : `<span class="pill pill-active">ACTIVE</span>`;

      return `
        <tr>
          <td style="text-align:left;">${statusPill}</td>
          <td style="text-align:left;">
            <input data-site-name="${escapeHtml(s.id)}" value="${escapeHtml(s.site_name||"")}" />
          </td>
          <td style="text-align:left;max-width:220px;">
            <span class="muted">${escapeHtml((s.lat ?? "-") + ", " + (s.lng ?? "-"))}</span>
          </td>
          <td style="text-align:left;width:120px;">
            <input data-site-radius="${escapeHtml(s.id)}" type="number" min="50" step="10" value="${escapeHtml(s.radius_m ?? 500)}" />
          </td>
          <td>
            <div class="rowBtns">
              <button class="tinyBtn" onclick="saveSite('${escapeHtml(s.id)}')">üíæ Save</button>
              <button class="tinyBtn ${isArch ? '' : 'ghostBtn'}" onclick="toggleSite('${escapeHtml(s.id)}')">
                ${isArch ? 'Unarchive' : 'Archive'}
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

  wrap.innerHTML = `
    <table class="adminTable">
      <thead>
        <tr>
          <th>Status</th>
          <th>Site Name</th>
          <th>Lat/Lng</th>
          <th>Radius (m)</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

async function saveSite(id){
  const nameEl = document.querySelector(`input[data-site-name="${CSS.escape(id)}"]`);
  const radEl  = document.querySelector(`input[data-site-radius="${CSS.escape(id)}"]`);
  const siteName = (nameEl?.value || "").trim();
  const radius = Number(radEl?.value || 500);

  if(!siteName){
    alert("Site name cannot be blank.");
    return;
  }

  await fetch(`${API_BASE}/update-site`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id, siteName, radius })
  });

  await fetchSites();
  renderSitesAdminTable();
  renderAll(); // updates dropdowns immediately
}

async function toggleSite(id){
  await fetch(`${API_BASE}/toggle-site`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id })
  });

  await fetchSites();
  renderSitesAdminTable();
  renderAll(); // site dropdown excludes archived
}

/* ======================================================================
   NEW: ENGINEERS ADMIN MODAL (edit + archive toggle + save rate)
   Requires worker endpoints:
     GET  /engineers
     POST /update-engineer { id, firstName, lastName, company, purpose, hourlyRate }
     POST /toggle-engineer { id }
====================================================================== */

function openEngineersModal(){
  document.getElementById("engineersModal").style.display="flex";
  renderEngineersAdminTable();
}

function closeEngineersModal(){
  document.getElementById("engineersModal").style.display="none";
}

function renderEngineersAdminTable(){
  const wrap = document.getElementById("engineersAdminBody");
  if(!engineersAll.length){
    wrap.innerHTML = `<div class="muted" style="text-align:left;">No engineers returned from /engineers.</div>`;
    return;
  }

  const rows = engineersAll
    .slice()
    .sort((a,b)=>{
      const an = `${a.first_name||""} ${a.last_name||""}`.trim();
      const bn = `${b.first_name||""} ${b.last_name||""}`.trim();
      return an.localeCompare(bn);
    })
    .map(p=>{
      const isArch = Number(p.archived||0) === 1;
      const statusPill = isArch
        ? `<span class="pill pill-arch">ARCHIVED</span>`
        : `<span class="pill pill-active">ACTIVE</span>`;

      return `
        <tr>
          <td style="text-align:left;">${statusPill}</td>

          <td style="text-align:left;width:140px;">
            <input data-eng-first="${escapeHtml(p.id)}" value="${escapeHtml(p.first_name||"")}" />
          </td>
          <td style="text-align:left;width:160px;">
            <input data-eng-last="${escapeHtml(p.id)}" value="${escapeHtml(p.last_name||"")}" />
          </td>

          <td style="text-align:left;width:220px;">
            <input data-eng-company="${escapeHtml(p.id)}" value="${escapeHtml(p.company||"")}" />
          </td>

          <td style="text-align:left;width:140px;">
            <input data-eng-purpose="${escapeHtml(p.id)}" value="${escapeHtml(p.purpose||"")}" />
          </td>

          <td style="text-align:left;width:120px;">
            <input data-eng-rate="${escapeHtml(p.id)}" type="number" step="0.01" min="0" value="${escapeHtml(p.hourly_rate ?? p.rate ?? "")}" placeholder="(optional)" />
          </td>

          <td>
            <div class="rowBtns">
              <button class="tinyBtn" onclick="saveEngineer('${escapeHtml(p.id)}')">üíæ Save</button>
              <button class="tinyBtn ${isArch ? '' : 'ghostBtn'}" onclick="toggleEngineer('${escapeHtml(p.id)}')">
                ${isArch ? 'Unarchive' : 'Archive'}
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

  wrap.innerHTML = `
    <table class="adminTable">
      <thead>
        <tr>
          <th>Status</th>
          <th>First</th>
          <th>Last</th>
          <th>Company</th>
          <th>Purpose</th>
          <th>Rate (¬£/hr)</th>
          <th style="text-align:right;">Actions</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

async function saveEngineer(id){
  const firstName = (document.querySelector(`input[data-eng-first="${CSS.escape(id)}"]`)?.value || "").trim();
  const lastName  = (document.querySelector(`input[data-eng-last="${CSS.escape(id)}"]`)?.value || "").trim();
  const company   = (document.querySelector(`input[data-eng-company="${CSS.escape(id)}"]`)?.value || "").trim();
  const purpose   = (document.querySelector(`input[data-eng-purpose="${CSS.escape(id)}"]`)?.value || "").trim();
  const rateRaw   = (document.querySelector(`input[data-eng-rate="${CSS.escape(id)}"]`)?.value || "").trim();
  const hourlyRate = rateRaw === "" ? null : Number(rateRaw);

  if(!firstName && !lastName){
    alert("Engineer must have at least a first or last name.");
    return;
  }

  await fetch(`${API_BASE}/update-engineer`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id, firstName, lastName, company, purpose, hourlyRate })
  });

  await fetchEngineers();
  renderEngineersAdminTable();
  renderAll(); // person dropdown excludes archived engineers
}

async function toggleEngineer(id){
  await fetch(`${API_BASE}/toggle-engineer`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ id })
  });

  await fetchEngineers();
  renderEngineersAdminTable();
  renderAll();
}
  /* ======================================================================
   NEW: COMPANIES ADMIN MODAL (assign companies per site)
====================================================================== */

let companiesAll = [];

async function fetchCompaniesMaster(){
  try{
    const res = await fetch(`${API_BASE}/companies`);
    const data = await res.json();
    companiesAll = data.companies || [];
  }catch(e){
    companiesAll = [];
  }
}

async function openCompaniesModal(){
  await fetchSites();
  await fetchCompaniesMaster();
  document.getElementById("companiesModal").style.display="flex";
  renderCompaniesAdmin();
}

function closeCompaniesModal(){
  document.getElementById("companiesModal").style.display="none";
}

async function renderCompaniesAdmin(){

  const wrap = document.getElementById("companiesAdminBody");

  if(!sitesActive.length){
    wrap.innerHTML = `<div class="muted">No active sites found.</div>`;
    return;
  }

  let html = `<table class="adminTable"><thead><tr>
    <th>Site</th>
    ${companiesAll.map(c=>`<th>${escapeHtml(c.name)}</th>`).join("")}
  </tr></thead><tbody>`;

  for(const site of sitesActive){

    const res = await fetch(`${API_BASE}/companies-for-site?site=${encodeURIComponent(site.site_name)}`);
    const data = await res.json();
    const assigned = (data.companies || []).map(c=>c.id);

    html += `<tr><td style="text-align:left;font-weight:600;">${escapeHtml(site.site_name)}</td>`;

    for(const c of companiesAll){
      const checked = assigned.includes(c.id) ? "checked" : "";
      html += `
        <td style="text-align:center;">
          <input type="checkbox"
            data-site="${escapeHtml(site.id)}"
            data-company="${escapeHtml(c.id)}"
            ${checked}>
        </td>
      `;
    }

    html += `</tr>`;
  }

  html += `</tbody></table>
    <div style="margin-top:15px;">
      <button onclick="saveCompanyMappings()">üíæ Save Changes</button>
    </div>`;

  wrap.innerHTML = html;
}

async function saveCompanyMappings(){

  const checkboxes = document.querySelectorAll("#companiesAdminBody input[type='checkbox']");

  const map = {};

  checkboxes.forEach(cb=>{
    const site = cb.dataset.site;
    const company = cb.dataset.company;

    if(!map[site]) map[site] = [];
    if(cb.checked) map[site].push(company);
  });

  await fetch(`${API_BASE}/update-site-companies`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(map)
  });

  alert("Company mappings updated.");
}
</script>

<!-- DELETE MODAL (EXISTING) -->
<div id="deleteModal" class="modal">
  <div class="modalContent">
    <h3>Delete Visit</h3>
    <p id="deleteText"></p>
    <button class="dangerBtn" onclick="confirmDelete()">Confirm Delete</button>
    <button onclick="closeDeleteModal()" style="background:#ccc;color:#333;">Cancel</button>
  </div>
</div>

<!-- EXPORT MODAL (EXISTING) -->
<div id="exportModal" class="modal">
  <div class="modalContent">
    <h3>Export Report</h3>
    <p>This will export current filtered results.</p>
    <button onclick="generatePDF()">Generate PDF</button>
    <button onclick="closeExportModal()" style="background:#ccc;color:#333;">Cancel</button>
  </div>
</div>

<!-- NEW: SITES ADMIN MODAL -->
<div id="sitesModal" class="modal">
  <div class="modalContent">
    <div class="modalHead">
      <h3>üóÇ Sites ‚Äî View / Edit / Archive</h3>
      <button class="ghostBtn" onclick="closeSitesModal()">‚úï Close</button>
    </div>
    <div class="modalNote">
      Archived sites are hidden from the <strong>Site</strong> dropdown and are excluded from <strong>/scan</strong> matching.
      Historical logs will still show archived site names where they occurred.
    </div>
    <div id="sitesAdminBody"></div>
  </div>
</div>

<!-- NEW: ENGINEERS ADMIN MODAL -->
<div id="engineersModal" class="modal">
  <div class="modalContent">
    <div class="modalHead">
      <h3>üë∑ Engineers ‚Äî View / Edit / Archive / Rates</h3>
      <button class="ghostBtn" onclick="closeEngineersModal()">‚úï Close</button>
    </div>
    <div class="modalNote">
      Archived engineers are hidden from the <strong>People</strong> dropdown.
      Rates are stored here for later use (does not change any current hours logic).
    </div>
    <div id="engineersAdminBody"></div>
  </div>
</div>
<!-- NEW: COMPANIES ADMIN MODAL -->
<div id="companiesModal" class="modal">
  <div class="modalContent">
    <div class="modalHead">
      <h3>üè¢ Assign Companies Per Site</h3>
      <button class="ghostBtn" onclick="closeCompaniesModal()">‚úï Close</button>
    </div>
    <div class="modalNote">
      Tick which companies should appear during registration for each site.
      Changes apply immediately to new registrations.
    </div>
    <div id="companiesAdminBody"></div>
  </div>
</div>
</body>
</html>
