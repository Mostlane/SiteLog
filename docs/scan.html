<!DOCTYPE html>
<html>
<head>
  <title>Scan Site</title>
</head>
<body>
  <h1>üì≤ Site Scan</h1>

  <!-- THIS ELEMENT IS REQUIRED -->
  <p id="status">Loading...</p>

  <script>
    const params = new URLSearchParams(window.location.search);
    const siteCode = params.get("site");

    let token = localStorage.getItem("deviceToken");
    if (!token) {
      token = crypto.randomUUID();
      localStorage.setItem("deviceToken", token);
    }

    async function scan() {
      try {
        const statusEl = document.getElementById("status");
        statusEl.innerText = "Scanning‚Ä¶";

        const res = await fetch(
          "https://sitelog-api.jamie-def.workers.dev/scan",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              siteCode,
              deviceToken: token
            })
          }
        );

        const data = await res.json();

        statusEl.innerText =
          data.status === "checked_in"
            ? "‚úÖ You are now CHECKED IN"
            : "üëã You are now CHECKED OUT";
      } catch (err) {
        document.getElementById("status").innerText =
          "‚ùå Error: " + err.message;
      }
    }

    scan();
  </script>
</body>
</html>
