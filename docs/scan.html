<!DOCTYPE html>
<html>
<head>
  <title>SiteLog Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANo2Q7OehYzHTTgMTxRr5ISamf5IradcM"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 32px 16px;
      text-align: center;
    }

    h1 {
      background: rgba(0, 59, 130, 0.85);
      color: white;
      padding: 14px;
      border-radius: 12px;
      max-width: 520px;
      margin: auto;
      font-size: 20px;
      font-weight: 600;
    }

    .logo {
      display: block;
      margin: 18px auto 8px;
      max-width: 200px;
    }

    #card {
      margin: 20px auto;
      max-width: 520px;
      background: rgba(255,255,255,0.97);
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.15);
    }

    #map {
      height: 260px;
      border-radius: 16px;
      margin-top: 14px;
      pointer-events: none;
      touch-action: none;
    }

    .field {
      position: relative;
      margin-top: 18px;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 18px 14px 8px;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      font-size: 16px;
      background: #f8fafc;
      appearance: none;
    }

    .field label {
      position: absolute;
      left: 14px;
      top: 14px;
      font-size: 14px;
      color: #64748b;
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .field input:focus + label,
    .field input:not(:placeholder-shown) + label,
    .field select:focus + label,
    .field select:valid + label {
      top: 4px;
      font-size: 11px;
      color: #003b82;
    }

    button {
      width: 100%;
      margin-top: 24px;
      padding: 16px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg,#003b82,#0057c2);
      color: white;
      font-size: 17px;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(0,59,130,0.4);
      cursor: pointer;
    }

    .site-notice {
      margin: 14px auto;
      padding: 14px;
      max-width: 520px;
      border-radius: 16px;
      background: white;
      border: 2px solid rgba(0,59,130,0.25);
      font-weight: 500;
    }

    /* ===== SUCCESS OVERLAY ===== */
    #successOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 9999;
    }

    #successOverlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .success-box {
      background: white;
      padding: 40px;
      border-radius: 28px;
      text-align: center;
      animation: pop 0.4s ease;
    }

    .success-box h2 {
      margin: 14px 0 0;
      font-size: 24px;
      font-weight: 700;
    }

    .tick {
      font-size: 70px;
      color: #16a34a;
      animation: scaleIn 0.5s ease;
    }

    @keyframes pop {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0); }
      to { transform: scale(1); }
    }
  </style>
</head>

<body>

<h1 id="title">Checking Location…</h1>

<img src="/SiteLog/Mostlane%20Logo.jpg" class="logo"/>

<div class="site-notice" id="noticeBox">
  ⚠️ Report to site foreman
</div>

<div id="card">
  <div id="status">Requesting GPS…</div>
  <div id="map"></div>

  <div id="registerBox" style="display:none;">
    <h3>First Visit Registration</h3>

    <div class="field">
      <input id="firstName" placeholder=" " />
      <label>First Name</label>
    </div>

    <div class="field">
      <input id="lastName" placeholder=" " />
      <label>Last Name</label>
    </div>

    <div class="field">
      <select id="purpose" required>
        <option value="" disabled selected hidden></option>
        <option>Visiting</option>
        <option>Contractor</option>
      </select>
      <label>Select from list</label>
    </div>

    <div class="field">
      <select id="company" required>
        <option value="" disabled selected hidden></option>
      </select>
      <label>Select from list</label>
    </div>

    <label style="display:block; margin-top:16px;">
      <input type="checkbox" id="hsAck">
      I have read site rules
    </label>

    <button onclick="register()">Confirm & Check In</button>
  </div>
</div>

<!-- SUCCESS OVERLAY -->
<div id="successOverlay">
  <div class="success-box">
    <div class="tick">✓</div>
    <h2 id="successText">Checked In</h2>
  </div>
</div>

<script>
const API = "https://sitelog-api.jamie-def.workers.dev";

let deviceToken = localStorage.getItem("mostlane_device_id");
if (!deviceToken) {
  deviceToken = crypto.randomUUID();
  localStorage.setItem("mostlane_device_id", deviceToken);
}

let lastLocation = null;
let currentSite = null;

function showSuccess(message) {
  document.getElementById("successText").innerText = message;
  const overlay = document.getElementById("successOverlay");
  overlay.classList.add("active");

  setTimeout(() => {
    overlay.classList.remove("active");
  }, 1800);
}

function showMap(lat, lng) {
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat, lng },
    zoom: 18,
    mapTypeId: "hybrid",
    disableDefaultUI: true,
    draggable: false,
    scrollwheel: false,
    gestureHandling: "none"
  });
  new google.maps.Marker({ position: { lat, lng }, map });
}

/* Load companies dynamically */
async function loadCompaniesForSite(siteName) {
  const res = await fetch(API + "/companies-for-site?site=" + encodeURIComponent(siteName));
  const data = await res.json();
  const select = document.getElementById("company");
  select.innerHTML = '<option value="" disabled selected hidden></option>';
  data.companies.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.name;
    opt.textContent = c.name;
    select.appendChild(opt);
  });
}

async function scan() {
  const res = await fetch(API + "/scan", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      deviceToken,
      lat: lastLocation.lat,
      lng: lastLocation.lng,
      accuracy: lastLocation.accuracy
    })
  });

  const data = await res.json();

  if (data.status === "unknown_site") {
    document.getElementById("title").innerText = "Unknown Site";
    return;
  }

  currentSite = data.site;
  await loadCompaniesForSite(currentSite);

  if (data.status === "first_visit") {
    document.getElementById("registerBox").style.display = "block";
    return;
  }

  if (data.status === "checked_in") {
    showSuccess("Checked In");
  }

  if (data.status === "checked_out") {
    showSuccess("Checked Out");
  }
}

async function register() {
  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const purpose = document.getElementById("purpose").value;
  const company = document.getElementById("company").value;
  const hsAck = document.getElementById("hsAck").checked;

  if (!firstName || !lastName || !purpose || !company || !hsAck) {
    alert("Complete all fields.");
    return;
  }

  await fetch(API + "/register", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      deviceToken,
      firstName,
      lastName,
      purpose,
      company,
      siteCode:currentSite,
      lat:lastLocation.lat,
      lng:lastLocation.lng,
      accuracy:lastLocation.accuracy
    })
  });

  showSuccess("Checked In");
}

navigator.geolocation.getCurrentPosition(
  (pos)=>{
    lastLocation={
      lat:pos.coords.latitude,
      lng:pos.coords.longitude,
      accuracy:pos.coords.accuracy
    };
    showMap(lastLocation.lat,lastLocation.lng);
    scan();
  },
  ()=>{},
  {enableHighAccuracy:true}
);
</script>

</body>
</html>
