<!DOCTYPE html>
<html>
<head>
  <title>Site Check In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY"></script>

  <style>
    body.checkin-body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 30px 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    h1 {
      background-color: rgba(0, 74, 153, 0.7);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 22px;
      margin-bottom: 16px;
    }

    #status {
      margin: 12px 0;
      font-weight: bold;
    }

    #map {
      width: 100%;
      max-width: 420px;
      height: 280px;
      border-radius: 10px;
      border: 2px solid #004a99;
      margin-top: 12px;
    }

    .small {
      font-size: 12px;
      opacity: 0.7;
    }
  </style>
</head>

<body class="checkin-body">

<h1>Verifying Location‚Ä¶</h1>
<p id="status">Requesting GPS</p>
<div id="map"></div>
<p class="small" id="accuracy"></p>

<script>
/* -------------------------------------------------------
   Device ID (persistent, non-resettable unless user clears storage)
------------------------------------------------------- */
let deviceID = localStorage.getItem("mostlane_device_id");
if (!deviceID) {
  deviceID = crypto.randomUUID();
  localStorage.setItem("mostlane_device_id", deviceID);
}

/* -------------------------------------------------------
   Params
------------------------------------------------------- */
const params = new URLSearchParams(window.location.search);
const siteCode = params.get("site");

/* -------------------------------------------------------
   Worker
------------------------------------------------------- */
const WORKER_URL = "https://sitelog-api.jamie-def.workers.dev/scan";

/* -------------------------------------------------------
   GPS + Map + Scan
------------------------------------------------------- */
navigator.geolocation.getCurrentPosition(async pos => {

  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  const accuracy = Math.round(pos.coords.accuracy); // meters
  const timestamp = new Date().toISOString();

  document.getElementById("status").innerText = "Location confirmed";
  document.getElementById("accuracy").innerText =
    `Accuracy: ¬±${accuracy}m`;

  /* Google Map */
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat, lng },
    zoom: 18,
    mapTypeId: "hybrid",
    disableDefaultUI: true
  });

  new google.maps.Marker({
    position: { lat, lng },
    map,
    title: "Your Location"
  });

  /* Send to Worker */
  const res = await fetch(WORKER_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      siteCode,
      deviceToken: deviceID,
      lat,
      lng,
      accuracy,
      timestamp,
      userAgent: navigator.userAgent
    })
  });

  const data = await res.json();

  document.querySelector("h1").innerText =
    data.status === "checked_in"
      ? "‚úÖ Checked In"
      : "üëã Checked Out";

}, err => {
  document.getElementById("status").innerText =
    "‚ùå Location required to check in";
}, {
  enableHighAccuracy: true,
  timeout: 20000,
  maximumAge: 0
});
</script>

</body>
</html>
