<!DOCTYPE html>
<html>
<head>
  <title>SiteLog Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyANo2Q7OehYzHTTgMTxRr5ISamf5IradcM"></script>

  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #e6e8eb url('Mostlane_Embossed.png') no-repeat center center fixed;
      background-size: 180%;
      margin: 0;
      padding: 40px 20px;
      text-align: center;
    }

    h1 {
      background: rgba(0, 74, 153, 0.7);
      color: white;
      padding: 12px;
      border-radius: 10px;
      max-width: 520px;
      margin: auto;
    }

    .logo {
      display: block;
      margin: 16px auto 10px;
      max-width: 220px;
      width: 100%;
    }

    #card {
      margin: 20px auto;
      max-width: 520px;
      background: rgba(255,255,255,0.95);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    /* üîí MAP LOCKED */
    #map {
      height: 260px;
      border-radius: 10px;
      margin-top: 10px;
      touch-action: none;
      pointer-events: none;
    }

    /* ‚úÖ iOS-centred, consistent inputs/selects/buttons */
    input, select, button {
      display: block;
      width: 100%;
      max-width: 480px;           /* keeps everything visually centred */
      box-sizing: border-box;     /* stops iOS sizing weirdness */
      margin: 10px auto 0;        /* true centre */
      padding: 12px 14px;         /* consistent internal spacing */
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      text-align: center;
      background: #fff;
      font-size: 16px;            /* prevents iOS zoom on focus */
      line-height: 1.2;
      -webkit-appearance: none;   /* normalise iOS input rendering */
      appearance: none;
    }

    /* Keep select arrow visible on iOS */
    select {
      -webkit-appearance: menulist;
      appearance: menulist;
    }

    input::placeholder {
      text-align: center;
      color: #9aa3af;
    }

    select:invalid { color: #6b7280; } /* placeholder grey */
    option { color: #0f172a; }

    button {
      background: #004a99;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      padding: 14px 14px;
    }

    .site-notice {
      margin: 12px auto 18px;
      padding: 14px 16px;
      max-width: 520px;
      border-radius: 14px;
      background: rgba(255,255,255,0.9);
      border: 2px solid rgba(0,59,130,0.25);
      color: #0f172a;
      font-size: 18px;
      text-align: center;
    }

    .site-notice strong {
      color: #003b82;
    }

    /* Make checkbox row look cleaner on mobile */
    #registerBox label{
      max-width: 480px;
      margin: 14px auto 0;
      text-align: left;
      display: flex;
      gap: 10px;
      align-items: flex-start;
      color:#0f172a;
      line-height: 1.25;
    }
    #registerBox label input[type="checkbox"]{
      width: 26px;
      height: 26px;
      margin: 0;
      padding: 0;
      border-radius: 6px;
      -webkit-appearance: auto;
      appearance: auto;
    }

    /* ==============================
       ‚úÖ BIG SUCCESS OVERLAY (NEW)
    ============================== */
    #successOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.72);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease;
      z-index: 9999;
    }
    #successOverlay.active {
      opacity: 1;
      pointer-events: auto;
    }
    .successCard {
      background: rgba(255,255,255,0.98);
      width: min(520px, calc(100% - 40px));
      border-radius: 26px;
      padding: 44px 22px;
      box-shadow: 0 18px 50px rgba(0,0,0,0.28);
      transform: scale(.90);
      transition: transform .25s ease;
    }
    #successOverlay.active .successCard {
      transform: scale(1);
    }
    .successIcon {
      font-size: 76px;
      line-height: 1;
      margin-bottom: 12px;
    }
    .successTitle {
      font-size: 30px;
      font-weight: 800;
      letter-spacing: .2px;
      margin: 0;
      color: #0f172a;
    }
    .successSub {
      margin-top: 10px;
      font-size: 16px;
      color: #334155;
    }
    .successSite {
      margin-top: 14px;
      display: inline-block;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,59,130,0.08);
      border: 1px solid rgba(0,59,130,0.14);
      color: #003b82;
      font-weight: 700;
    }
    /* üîí Hide site label on overlay */
#successSite {
  display: none !important;
}
  </style>
</head>

<body>

<h1 id="title">Checking Location‚Ä¶</h1>

<img src="/SiteLog/Mostlane%20Logo.jpg" alt="Mostlane" class="logo"/>

<div class="site-notice" id="noticeBox">
  <strong>‚ö†Ô∏è Site Notice:</strong> Report to site foreman
</div>

<div id="card">
  <div id="status">Requesting GPS‚Ä¶</div>
  <div id="map"></div>

  <div id="registerBox" style="display:none; text-align:center;">
    <h3>First Visit Registration</h3>

    <input id="firstName" placeholder="First Name">
    <input id="lastName" placeholder="Last Name">

    <!-- ‚úÖ PURPOSE DROPDOWN WITH PLACEHOLDER -->
    <select id="purpose" required>
      <option value="" disabled selected>Select from list</option>
      <option value="Visiting">Visiting</option>
      <option value="Contractor">Contractor</option>
    </select>

    <!-- ‚úÖ COMPANY DROPDOWN WITH PLACEHOLDER -->
    <select id="company" required>
      <option value="" disabled selected>Select from list</option>
      <!-- Dynamically populated -->
    </select>

    <label>
      <input type="checkbox" id="hsAck">
      <span>I have read site rules and will report to site foreman</span>
    </label>

    <button onclick="register()">Confirm & Check In</button>
  </div>
</div>

<!-- ‚úÖ SUCCESS OVERLAY (NEW) -->
<div id="successOverlay" aria-hidden="true">
  <div class="successCard" role="dialog" aria-modal="true">
    <div id="successIcon" class="successIcon">‚úÖ</div>
    <h2 id="successTitle" class="successTitle">Checked In</h2>
    <div id="successSub" class="successSub">Recorded successfully</div>
    <div id="successSite" class="successSite" style="display:none;">Site</div>
  </div>
</div>

<script>
 // =====================================
// TAB REUSE DETECTION (SAFER VERSION)
// =====================================
const TAB_KEY = "mostlane_active_tab";
const TAB_ID = crypto.randomUUID();

if (localStorage.getItem(TAB_KEY)) {
  document.body.innerHTML = `
    <div style="padding:40px;font-family:Segoe UI;text-align:center;">
      <h2>SiteLog Already Open</h2>
      <p>Please return to the existing SiteLog window.</p>
    </div>
  `;
  throw new Error("Duplicate tab stopped");
} else {
  localStorage.setItem(TAB_KEY, TAB_ID);
}

window.addEventListener("beforeunload", () => {
  if (localStorage.getItem(TAB_KEY) === TAB_ID) {
    localStorage.removeItem(TAB_KEY);
  }
});
const API = "https://sitelog-api.jamie-def.workers.dev";

let deviceToken = localStorage.getItem("mostlane_device_id");
if (!deviceToken) {
  deviceToken = crypto.randomUUID();
  localStorage.setItem("mostlane_device_id", deviceToken);
}

let lastLocation = null;
let currentSite = null;

/* ==============================
   ‚úÖ BIG OVERLAY POPUP (NEW)
   type: "in" | "out" | "reg"
============================== */
function showSuccessOverlay(type, siteName) {
  const overlay = document.getElementById("successOverlay");
  const icon = document.getElementById("successIcon");
  const title = document.getElementById("successTitle");
  const sub = document.getElementById("successSub");
  const site = document.getElementById("successSite");

  // default
  site.style.display = (siteName ? "inline-block" : "none");
  site.textContent = siteName ? siteName : "";

  if (type === "in") {
    icon.textContent = "‚úÖ";
    title.textContent = "Checked In";
    sub.textContent = "You're signed in on site";
  } else if (type === "out") {
    icon.textContent = "üëã";
    title.textContent = "Checked Out";
    sub.textContent = "Visit completed";
  } else { // reg
    icon.textContent = "‚úÖ";
    title.textContent = "Registered";
    sub.textContent = "Check-in confirmed";
  }

  overlay.classList.add("active");
  overlay.setAttribute("aria-hidden", "false");

  // small haptic if supported
  try { if (navigator.vibrate) navigator.vibrate(70); } catch(e){}

  // auto-hide (keeps page behind intact)
  window.clearTimeout(window.__mlOverlayT);
  window.__mlOverlayT = window.setTimeout(() => {
    overlay.classList.remove("active");
    overlay.setAttribute("aria-hidden", "true");
  }, 1700);
}

/* üîí LOCKED MAP VERSION */
function showMap(lat, lng) {
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat, lng },
    zoom: 18,
    mapTypeId: "hybrid",
    disableDefaultUI: true,
    draggable: false,
    scrollwheel: false,
    disableDoubleClickZoom: true,
    keyboardShortcuts: false,
    gestureHandling: "none"
  });

  new google.maps.Marker({ position: { lat, lng }, map });
}

/* ======================================
   LOAD COMPANIES FOR SITE
======================================*/
async function loadCompaniesForSite(siteName) {
  try {
    const res = await fetch(API + "/companies-for-site?site=" + encodeURIComponent(siteName));
    const data = await res.json();

    const companySelect = document.getElementById("company");

    // reset to placeholder
    companySelect.innerHTML = `<option value="" disabled selected>Select from list</option>`;

    if (data.companies && data.companies.length > 0) {
      data.companies.forEach(c => {
        const option = document.createElement("option");
        option.value = c.name;
        option.textContent = c.name;
        companySelect.appendChild(option);
      });
    }

    // If we have a saved profile company and it exists in this site‚Äôs list, preselect it
    const savedProfile = localStorage.getItem("mostlane_profile");
    if (savedProfile) {
      const profile = JSON.parse(savedProfile);
      const savedCompany = (profile.company || "").trim();
      if (savedCompany) {
        const exists = [...companySelect.options].some(o => o.value === savedCompany);
        if (exists) companySelect.value = savedCompany;
      }
    }

  } catch (err) {
    console.error("Company load failed:", err);
  }
}

async function scan() {
  const res = await fetch(API + "/scan", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      deviceToken,
      lat: lastLocation.lat,
      lng: lastLocation.lng,
      accuracy: lastLocation.accuracy
    })
  });

  const data = await res.json();
  const noticeBox = document.getElementById("noticeBox");

  if (data.status === "unknown_site") {
    document.getElementById("title").innerText = "‚ùå Unknown Site";
    document.getElementById("status").innerText =
      "You are not within range of an active Mostlane job.";
    return;
  }

  currentSite = data.site;

  // load companies for this site (used for registration)
  await loadCompaniesForSite(currentSite);

  const firstName = data.firstName || "";
  const companyName = data.company || "";

  if (data.status === "first_visit") {
    document.getElementById("status").innerText =
      "First visit at " + currentSite + " ‚Äî please register.";

    const savedProfile = localStorage.getItem("mostlane_profile");
    if (savedProfile) {
      const profile = JSON.parse(savedProfile);
      document.getElementById("firstName").value = profile.firstName || "";
      document.getElementById("lastName").value = profile.lastName || "";

      // purpose preselect if valid
      const savedPurpose = (profile.purpose || "").trim();
      if (savedPurpose === "Visiting" || savedPurpose === "Contractor") {
        document.getElementById("purpose").value = savedPurpose;
      } else {
        document.getElementById("purpose").value = "";
      }
      // company is preselected inside loadCompaniesForSite()
    }

    document.getElementById("registerBox").style.display = "block";
    return;
  }

  if (data.status === "checked_in") {
    localStorage.setItem("mostlane_last_checkin", Date.now());

    document.getElementById("title").innerText = "‚úÖ Checked In";
    document.getElementById("status").innerText =
      (firstName && companyName)
        ? `Welcome Back ${firstName} from ${companyName}`
        : "You are now on site: " + currentSite;

    noticeBox.innerHTML =
      "<strong>‚ö†Ô∏è Site Notice:</strong> Report to site foreman";

    // ‚úÖ overlay (NEW)
    showSuccessOverlay("in", currentSite);
  }

  if (data.status === "checked_out") {
    const start = localStorage.getItem("mostlane_last_checkin");

    let durationText = "";
    if (start) {
      const mins = Math.round((Date.now() - start) / 60000);
      const hrs = Math.floor(mins / 60);
      const rem = mins % 60;
      durationText = hrs > 0 ? `${hrs}h ${rem}m` : `${mins}m`;
      localStorage.removeItem("mostlane_last_checkin");
    }

    document.getElementById("title").innerText = "üëã Checked Out";
    document.getElementById("status").innerText =
      firstName
        ? `Goodbye ${firstName} ‚Äî Total time on site: ${durationText || "Recorded"}`
        : "Total time on site: " + (durationText || "Recorded");

    noticeBox.innerHTML =
      "<strong>‚úÖ Visit Complete:</strong> Thank you, you may now leave site.";

    // ‚úÖ overlay (NEW)
    showSuccessOverlay("out", currentSite);
  }
}

async function register() {
  const firstName = document.getElementById("firstName").value.trim();
  const lastName = document.getElementById("lastName").value.trim();
  const purpose = document.getElementById("purpose").value;
  const company = document.getElementById("company").value;
  const hsAck = document.getElementById("hsAck").checked;

  if (!firstName || !lastName || !purpose || !company || !hsAck) {
    alert("Complete all fields and confirm site rules.");
    return;
  }

  localStorage.setItem("mostlane_profile", JSON.stringify({
    firstName,
    lastName,
    purpose,
    company
  }));

  await fetch(API + "/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      deviceToken,
      firstName,
      lastName,
      purpose,
      company,
      siteCode: currentSite,
      lat: lastLocation.lat,
      lng: lastLocation.lng,
      accuracy: lastLocation.accuracy
    })
  });

  document.getElementById("registerBox").style.display = "none";
  document.getElementById("title").innerText = "‚úÖ Checked In";
  document.getElementById("status").innerText =
    "Registered successfully at " + currentSite;

  // ‚úÖ overlay (NEW)
  showSuccessOverlay("reg", currentSite);

  window.scrollTo({ top: 0, behavior: "smooth" });
}

function startLocation() {
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      lastLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy
      };

      showMap(lastLocation.lat, lastLocation.lng);
      scan();
    },
    (err) => {
      document.getElementById("status").innerText =
        "Location required: " + err.message;
    },
    { enableHighAccuracy: true, timeout: 20000 }
  );
}

if (navigator.permissions && navigator.permissions.query) {
  navigator.permissions.query({ name: "geolocation" }).then((result) => {
    if (result.state === "granted" || result.state === "prompt") {
      startLocation();
    } else {
      document.getElementById("status").innerText =
        "Location access is required. Please enable it in your browser settings.";
    }
  }).catch(() => startLocation());
} else {
  startLocation();
}
</script>

</body>
</html>
